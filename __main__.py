r"""
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣄⢶⣶⣶⣶⣶⣶⣶⣶⣤⣤⡤⣀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡠⣒⣵⣿⣿⣿⠟⢉⣭⣭⣿⡿⣮⢻⣿⣿⡿⡻⣿⡞⠛⠋⠹⢗⣮⣗⠦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠠⠄⠀⡀⡖⠒⠒⢩⣾⣿⣿⣿⣿⣷⣮⣿⣿⠁⠈⢉⣿⢧⡹⣿⣷⡦⠿⠷⠤⠤⠤⠤⠭⠵⠭⠪⢝⣦⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⣀⠀⠀⠀⠀⠉⠉⠉⢉⠉⡉⠉⠉⠉⠉⠉⠉⠛⠉⠉⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⣀⠎⠀⠀⠀⠀⠀⠀⠀⠈⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⡄⠀⠀⠀⣀⣀⣀⠀⠀⠀⠀⠀⠀⢠⢶⣶⣶⣶⣶⣦⣤⣤⡄⠐⠒⠀⠒⠂⠀⠂⠠⣦⠀⠀⠀⠀
⠀⠀⠀⢀⣴⣿⣶⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡇⠀⠀⣰⣿⡿⣿⣿⣷⣄⠀⠀⠀⠀⠈⠛⠛⠚⠛⠛⠛⠿⠿⠷⠘⣿⠿⣿⢿⣿⢿⡇⠸⢧⡀⠀⠀
⢸⠀⠀⢸⣿⣿⣿⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣇⡀⢰⣿⣿⣿⣿⣿⣿⣿⡆⢤⠀⠀⠀⠀⠀⠀⢰⣶⢲⡆⠀⠀⠀⣀⣀⣠⠀⠀⠠⢀⢠⠀⡇⠀⠀
⠀⢇⡀⢸⠻⣿⣿⣿⣇⠀⠀⠀⠑⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⢀⣼⣿⣿⣿⣿⣿⡟⣿⣿⠀⢃⠀⠀⠀⠀⠀⣬⣭⣭⣤⡄⠀⠀⣿⣿⡿⠸⠿⠇⡏⣸⢆⠇⠀⠀
⠀⠀⠉⠻⣿⣷⣿⣿⣿⣀⣀⣀⣀⣠⣀⣀⣀⣀⣀⣀⣀⣀⣀⠈⠀⠀⢻⣿⣿⣿⣿⣿⣯⣿⣿⣀⣘⣀⣀⣀⣀⣘⣉⣉⣉⣉⣁⣀⣀⣛⣛⣛⣛⣛⠭⣥⣭⣼⠀⠀⠀
⠀⠀⠀⠀⠹⣿⣿⣿⣿⣿⣯⣭⣭⣭⣭⣭⣭⣤⣤⣤⣼⣿⣿⣿⣿⣏⣉⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣶⣶⣶⡶⠶⠶⠾⠿⠛⠂⠀⠀
⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠛⠛⠛⠛⠛⠻⠿⠿⢿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣶⣶⣶⣶⣶⣶⣾⣿⣿⣿⣿⣿⣿⣶⡦⠤⠀⠀⠀⠀⠉⠐
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠉⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

__        __    _       _  __   __    ____             _    
\ \      / /_ _| |_ ___| |_\ \ / /__ | __ )  __ _  ___| | __
 \ \ /\ / / _` | __/ __| '_ \ V / _ \|  _ \ / _` |/ __| |/ /
  \ V  V / (_| | || (__| | | | | (_) | |_) | (_| | (__|   < 
   \_/\_/ \__,_|\__\___|_| |_|_|\___/|____/ \__,_|\___|_|\_\
       
A simple tool to watch a git repository for changes.
"""

import argparse
import subprocess
import time
import sys
import logging
from pathlib import Path

logger = logging.getLogger("git_watcher")


class GitWatcher:
    def __init__(
        self,
        repo_path: str,
        action_command: str | None,
        interval: int = 10,
        auto_pull: bool = True,
    ):
        self.repo_path = Path(repo_path).resolve()
        self.action_command = action_command
        self.interval = interval
        self.auto_pull = auto_pull
        self._validate_repo()
        self.last_commit_hash = self._get_current_hash()

    def _validate_repo(self):
        """Validate that the path is a git repository"""
        try:
            subprocess.run(
                ["git", "rev-parse", "--is-inside-work-tree"],
                cwd=self.repo_path,
                check=True,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )
        except subprocess.CalledProcessError as e:
            raise ValueError(f"{self.repo_path} is not a valid Git repository: {e}")

    def _get_current_hash(self):
        """Get the current commit hash"""
        result = subprocess.run(
            ["git", "rev-parse", "HEAD"],
            cwd=self.repo_path,
            check=True,
            capture_output=True,
            text=True,
        )
        return result.stdout.strip()

    def check_for_changes(self):
        """Check if there are any changes in the repository"""
        if self.auto_pull:
            try:
                subprocess.run(
                    ["git", "pull", "origin"],
                    cwd=self.repo_path,
                    check=True,
                    stdout=subprocess.PIPE,
                    stderr=subprocess.PIPE,
                )
            except subprocess.CalledProcessError as e:
                logger.warning(f"Could not pull from remote: {e}")

        # Check if the commit hash has changed
        current_hash = self._get_current_hash()
        if current_hash != self.last_commit_hash:
            return True, current_hash

        return False, current_hash

    def run_action(self):
        """Run the specified action in the repository path"""
        if not self.action_command:
            return

        logger.info(f"Running action: {self.action_command}")
        try:
            subprocess.run(
                self.action_command, shell=True, cwd=self.repo_path, check=True
            )
            logger.info("Action completed successfully")
            return True
        except subprocess.CalledProcessError as e:
            logger.error(f"Action failed with error code {e.returncode}")
            return False

    def watch(self):
        """Start watching the repository for changes"""
        logger.info(f"Watching repository: {self.repo_path}")
        logger.info(f"Initial commit: {self.last_commit_hash[:7]}")
        logger.info(f"Polling interval: {self.interval} seconds")

        while True:
            changes_detected, current_hash = self.check_for_changes()
            logger.debug("Checking for changes... (current_hash: %s)", current_hash)

            if changes_detected:
                logger.info(
                    f"Changes detected - Previous: {self.last_commit_hash[:7]}, Current: {current_hash[:7]}"
                )
                self.run_action()
                self.last_commit_hash = current_hash

            time.sleep(self.interval)


def setup_logging(log_level):
    level = getattr(logging, log_level.upper(), logging.INFO)
    logging.basicConfig(
        level=level,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S",
    )


def main():
    parser = argparse.ArgumentParser(
        description="Watch a Git repository for changes and run an action"
    )
    parser.add_argument("repo_path", help="Path to the Git repository to watch")
    parser.add_argument(
        "--action",
        "-a",
        help="Command(s) to run when changes are detected (optional)",
        default=None,
    )
    parser.add_argument(
        "--interval",
        "-i",
        type=int,
        default=10,
        help="Polling interval in seconds (default: 10)",
    )
    parser.add_argument(
        "--no-pull", "-n", action="store_true", help="Disable automatic git pull"
    )
    parser.add_argument(
        "--log-level",
        "-l",
        default="INFO",
        choices=["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
        help="Set the logging level (default: INFO)",
    )

    args = parser.parse_args()

    setup_logging(args.log_level)

    repo_path = Path(args.repo_path).resolve()
    if not repo_path.exists():
        logger.error(f"Repository path {repo_path} does not exist")
        return 1

    try:
        watcher = GitWatcher(
            repo_path=repo_path,
            action_command=args.action,
            interval=args.interval,
            auto_pull=not args.no_pull,
        )
        watcher.watch()
    except KeyboardInterrupt:
        print("Stopping repository watcher")
    except ValueError as e:
        print(f"{e}")
        return 1

    return 0


if __name__ == "__main__":
    sys.exit(main())
